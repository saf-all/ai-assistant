<!DOCTYPE html>
<html>
<head>
    <title>SafAI - Your AI Learning Assistant</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif; background: #0a0a0a; color: #fff; display: flex; height: 100vh; }
        
        .sidebar { width: 280px; background: #000; border-right: 1px solid #1a1a1a; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #1a1a1a; }
        .logo { font-size: 24px; font-weight: 700; margin-bottom: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .new-chat-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 10px; color: #fff; cursor: pointer; font-size: 14px; font-weight: 600; transition: transform 0.2s; }
        .new-chat-btn:hover { transform: translateY(-2px); }
        
        .mode-tabs { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
        .mode-tab { padding: 8px; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 8px; color: #888; cursor: pointer; font-size: 12px; text-align: center; transition: all 0.2s; }
        .mode-tab:hover { background: #2a2a2a; color: #fff; }
        .mode-tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border-color: transparent; }
        
        .conversations { flex: 1; overflow-y: auto; padding: 12px; }
        .conv-item { padding: 12px; margin-bottom: 6px; border-radius: 10px; cursor: pointer; font-size: 13px; background: #0a0a0a; border: 1px solid #1a1a1a; transition: all 0.2s; }
        .conv-item:hover { background: #1a1a1a; border-color: #2a2a2a; }
        .conv-item.active { background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-color: #667eea; }
        .conv-title { font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .main { flex: 1; display: flex; flex-direction: column; }
        .header { padding: 20px 32px; border-bottom: 1px solid #1a1a1a; background: #000; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .header-title { font-size: 20px; font-weight: 600; }
        .mode-context { padding: 12px 16px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border: 1px solid #667eea; border-radius: 10px; font-size: 13px; line-height: 1.6; }
        .mode-context strong { color: #667eea; }
        
        .messages { flex: 1; overflow-y: auto; padding: 32px; background: #0a0a0a; }
        .message { margin-bottom: 32px; display: flex; gap: 16px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.user { justify-content: flex-end; }
        .message-avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
        .message.user .message-avatar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .message.assistant .message-avatar { background: #1a1a1a; }
        .message-content { max-width: 70%; padding: 16px 20px; border-radius: 16px; line-height: 1.7; font-size: 14px; }
        .message.user .message-content { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .message.assistant .message-content { background: #1a1a1a; border: 1px solid #2a2a2a; }
        
        .input-area { padding: 24px 32px; border-top: 1px solid #1a1a1a; background: #000; }
        .research-bar { display: none; padding: 16px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border: 1px solid #667eea; border-radius: 12px; margin-bottom: 16px; }
        .research-bar.active { display: block; }
        .research-input { width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 8px; color: #fff; font-size: 14px; }
        .research-btn { margin-top: 12px; padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 600; }
        
        .file-preview { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
        .file-preview-item { position: relative; padding: 12px 16px; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 10px; font-size: 13px; display: flex; align-items: center; gap: 8px; }
        .file-preview-item img { max-width: 80px; max-height: 80px; border-radius: 6px; }
        .file-preview-remove { cursor: pointer; color: #ff3b30; margin-left: 12px; font-weight: 600; }
        
        .input-box { display: flex; gap: 12px; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 16px; padding: 16px; align-items: flex-end; transition: border-color 0.2s; }
        .input-box:focus-within { border-color: #667eea; }
        .input-box textarea { flex: 1; background: transparent; border: none; color: #fff; resize: none; font-size: 14px; font-family: inherit; outline: none; max-height: 200px; }
        .input-actions { display: flex; gap: 8px; }
        .icon-btn { padding: 10px; background: transparent; border: none; color: #666; cursor: pointer; font-size: 20px; border-radius: 8px; transition: all 0.2s; }
        .icon-btn:hover { background: #2a2a2a; color: #fff; }
        .send-btn { padding: 10px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 10px; color: #fff; cursor: pointer; font-size: 14px; font-weight: 600; transition: transform 0.2s; }
        .send-btn:hover { transform: translateY(-2px); }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .logout { color: #667eea; text-decoration: none; font-size: 14px; font-weight: 500; }
        .empty { text-align: center; color: #666; padding: 64px; }
        .empty-icon { font-size: 64px; margin-bottom: 16px; }
        
        pre { background: #000; padding: 16px; border-radius: 12px; overflow-x: auto; border: 1px solid #2a2a2a; margin: 12px 0; }
        code { font-family: 'Courier New', monospace; font-size: 13px; }
        strong { color: #667eea; }
        
        input[type="file"] { display: none; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #2a2a2a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #3a3a3a; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">ü§ñ SafAI</div>
            <button class="new-chat-btn" onclick="newConversation()">+ New Conversation</button>
            <div class="mode-tabs">
                <div class="mode-tab {{ 'active' if current_mode == 'chat' else '' }}" data-mode="chat" onclick="selectMode('chat')">üí¨ Chat</div>
                <div class="mode-tab {{ 'active' if current_mode == 'research' else '' }}" data-mode="research" onclick="selectMode('research')">üîç Research</div>
                <div class="mode-tab {{ 'active' if current_mode == 'learn' else '' }}" data-mode="learn" onclick="selectMode('learn')">üìö Learn</div>
                <div class="mode-tab {{ 'active' if current_mode == 'code' else '' }}" data-mode="code" onclick="selectMode('code')">üíª Code</div>
            </div>
        </div>
        <div class="conversations" id="conversations">
            {% for conv in conversations %}
            <div class="conv-item" onclick="loadConversation({{ conv.id }})" data-id="{{ conv.id }}">
                <div class="conv-title">{{ conv.title }}</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="main">
        <div class="header">
            <div class="header-top">
                <div class="header-title" id="headerTitle">SafAI</div>
                <a href="/logout" class="logout">Logout</a>
            </div>
            <div class="mode-context" id="modeContext"></div>
        </div>

        <div class="messages" id="messages">
            <div class="empty">
                <div class="empty-icon">ü§ñ</div>
                <div>Hi! I'm SafAI, your AI learning assistant.</div>
                <div style="margin-top: 8px; color: #666;">Select a mode and start a conversation!</div>
            </div>
        </div>

        <div class="input-area">
            <div class="research-bar" id="researchBar">
                <input type="text" class="research-input" id="researchInput" placeholder="Enter topic for deep research...">
                <button class="research-btn" onclick="performResearch()">üîç Start Deep Research</button>
            </div>
            
            <div class="file-preview" id="filePreview"></div>
            <div class="input-box">
                <div class="input-actions">
                    <button class="icon-btn" onclick="document.getElementById('fileInput').click()" title="Attach file">üìé</button>
                    <input type="file" id="fileInput" multiple onchange="handleFileSelect(event)">
                </div>
                <textarea id="messageInput" placeholder="Ask SafAI anything..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage();}"></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        let currentConvId = null;
        let currentMode = '{{ current_mode }}';
        let attachedFiles = [];

        const modeInfo = {
            chat: {
                title: 'üí¨ Chat Mode',
                context: '<strong>General Assistant:</strong> Ask me anything! I can help with questions, explanations, problem-solving, and general knowledge across all topics.',
                placeholder: 'Ask me anything...'
            },
            research: {
                title: 'üîç Research Mode',
                context: '<strong>Deep Research:</strong> I conduct comprehensive research on any topic with detailed analysis, multiple perspectives, facts, statistics, and learning resources. Perfect for in-depth understanding.',
                placeholder: 'What would you like to research?'
            },
            learn: {
                title: 'üìö Learning Mode',
                context: '<strong>Interactive Learning:</strong> I\'m your patient teacher! I break down complex topics into simple steps, use analogies, provide examples, and adapt to your pace. Ask questions anytime!',
                placeholder: 'What would you like to learn today?'
            },
            code: {
                title: 'üíª Code Mode',
                context: '<strong>Programming Assistant:</strong> I help with coding, debugging, code review, best practices, and architecture. Share your code or describe what you\'re building!',
                placeholder: 'Describe your coding challenge...'
            }
        };

        function selectMode(mode) {
            currentMode = mode;
            window.location.href = `/?mode=${mode}`;
        }

        function updateModeUI() {
            const info = modeInfo[currentMode];
            document.getElementById('headerTitle').textContent = info.title;
            document.getElementById('modeContext').innerHTML = info.context;
            document.getElementById('messageInput').placeholder = info.placeholder;
            document.getElementById('researchBar').classList.toggle('active', currentMode === 'research');
        }

        async function newConversation() {
            const response = await fetch('/new-conversation', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title: 'New Chat', mode: currentMode})
            });
            const data = await response.json();
            currentConvId = data.id;
            document.getElementById('messages').innerHTML = '';
            attachedFiles = [];
            document.getElementById('filePreview').innerHTML = '';
            location.reload();
        }

        async function loadConversation(id) {
            currentConvId = id;
            document.querySelectorAll('.conv-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-id="${id}"]`).classList.add('active');
            
            const response = await fetch(`/conversation/${id}`);
            const data = await response.json();
            
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';
            
            data.messages.forEach(msg => {
                addMessage(msg.role, msg.content, msg.attachments);
            });
        }

        function addMessage(role, content, attachments) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'üë§' : 'ü§ñ';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            content = content.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
            content = content.replace(/`([^`]+)`/g, '<code style="background:#2a2a2a;padding:3px 8px;border-radius:6px;font-size:12px;">$1</code>');
            content = content.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            content = content.replace(/\n\n/g, '<br><br>');
            content = content.replace(/\n/g, '<br>');
            content = content.replace(/^(\d+)\.\s/gm, '<br>$1. ');
            content = content.replace(/^-\s/gm, '<br>‚Ä¢ ');
            
            contentDiv.innerHTML = content;
            
            if (role === 'user') {
                messageDiv.appendChild(contentDiv);
                messageDiv.appendChild(avatar);
            } else {
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(contentDiv);
            }
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function performResearch() {
            const query = document.getElementById('researchInput').value.trim();
            if (!query) return;
            
            if (!currentConvId) {
                const response = await fetch('/new-conversation', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({title: `Research: ${query.substring(0, 50)}`, mode: 'research'})
                });
                const data = await response.json();
                currentConvId = data.id;
            }
            
            addMessage('user', `üîç Deep Research: ${query}`);
            
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message assistant';
            loadingDiv.id = 'loading-msg';
            loadingDiv.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">üîÑ Conducting comprehensive research... This may take a moment.</div>
            `;
            document.getElementById('messages').appendChild(loadingDiv);
            
            const response = await fetch('/deep-research', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({query, conversation_id: currentConvId})
            });
            
            const data = await response.json();
            
            const loading = document.getElementById('loading-msg');
            if (loading) loading.remove();
            
            addMessage('assistant', data.result);
            document.getElementById('researchInput').value = '';
        }

        async function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            for (let file of files) {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('/upload-file', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (data.success) {
                    attachedFiles.push(data.filename);
                    displayFilePreview(data.filename, data.data);
                }
            }
        }

        function displayFilePreview(filename, imageData) {
            const preview = document.getElementById('filePreview');
            const item = document.createElement('div');
            item.className = 'file-preview-item';
            
            if (imageData) {
                item.innerHTML = `<img src="data:image/png;base64,${imageData}"><span>${filename}</span><span class="file-preview-remove" onclick="removeFile('${filename}')">‚úï</span>`;
            } else {
                item.innerHTML = `<span>üìÑ ${filename}</span><span class="file-preview-remove" onclick="removeFile('${filename}')">‚úï</span>`;
            }
            
            preview.appendChild(item);
        }

        function removeFile(filename) {
            attachedFiles = attachedFiles.filter(f => f !== filename);
            document.getElementById('filePreview').innerHTML = '';
            attachedFiles.forEach(f => displayFilePreview(f));
        }

        async function sendMessage() {
            if (!currentConvId) {
                const response = await fetch('/new-conversation', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({title: 'New Chat', mode: currentMode})
                });
                const data = await response.json();
                currentConvId = data.id;
            }
            
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message && attachedFiles.length === 0) return;
            
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            input.value = '';
            
            addMessage('user', message);
            
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message assistant';
            loadingDiv.id = 'loading-msg';
            loadingDiv.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">üí≠ Thinking...</div>
            `;
            document.getElementById('messages').appendChild(loadingDiv);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        conversation_id: currentConvId,
                        message: message,
                        attachments: attachedFiles
                    })
                });
                
                const data = await response.json();
                
                const loading = document.getElementById('loading-msg');
                if (loading) loading.remove();
                
                if (data.error) {
                    addMessage('assistant', `‚ùå Error: ${data.error}`);
                } else {
                    addMessage('assistant', data.response);
                }
            } catch (error) {
                const loading = document.getElementById('loading-msg');
                if (loading) loading.remove();
                addMessage('assistant', `‚ùå Error: ${error.message}`);
            }
            
            attachedFiles = [];
            document.getElementById('filePreview').innerHTML = '';
            sendBtn.disabled = false;
            input.focus();
        }

        document.getElementById('messageInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        updateModeUI();
    </script>
</body>
</html>
